<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flathead Robot Viewer</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }

        .header {
            background: #16213e;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #0f3460;
        }

        .header h1 {
            color: #e94560;
            font-size: 1.5rem;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
        }

        .status-dot.connected {
            background: #4caf50;
            box-shadow: 0 0 10px #4caf50;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .video-card {
            background: #16213e;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #0f3460;
        }

        .video-card h3 {
            padding: 1rem;
            background: #0f3460;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .video-container {
            position: relative;
            padding-top: 75%; /* 4:3 aspect ratio */
            background: #000;
        }

        .video-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .audio-section {
            background: #16213e;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #0f3460;
        }

        .audio-section h3 {
            margin-bottom: 1rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .audio-meters {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .meter {
            text-align: center;
        }

        .meter-bar {
            height: 100px;
            background: #0f3460;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .meter-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, #4caf50, #8bc34a, #ffeb3b, #ff9800, #f44336);
            transition: height 0.1s ease;
        }

        .meter-label {
            font-size: 0.75rem;
            color: #888;
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        button {
            background: #e94560;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        button:hover {
            background: #ff6b6b;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .stats {
            margin-top: 2rem;
            padding: 1rem;
            background: #0f3460;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
        }

        .no-robot {
            text-align: center;
            padding: 4rem;
            color: #666;
        }

        .no-robot h2 {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ FLATHEAD Viewer</h1>
        <div class="status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Disconnected</span>
        </div>
    </div>

    <div class="container">
        <div id="noRobot" class="no-robot">
            <h2>Waiting for robot...</h2>
            <p>Connect your Flathead robot to see the streams</p>
        </div>

        <div id="robotView" style="display: none;">
            <div class="video-grid">
                <div class="video-card">
                    <h3>üì∑ Left Camera</h3>
                    <div class="video-container">
                        <img id="videoLeft" src="" alt="Left camera">
                    </div>
                </div>
                <div class="video-card">
                    <h3>üì∑ Right Camera</h3>
                    <div class="video-container">
                        <img id="videoRight" src="" alt="Right camera">
                    </div>
                </div>
            </div>

            <div class="audio-section">
                <h3>üé§ Audio Levels</h3>
                <div class="audio-meters">
                    <div class="meter">
                        <div class="meter-bar">
                            <div class="meter-fill" id="meterFL" style="height: 0%"></div>
                        </div>
                        <div class="meter-label">Front Left</div>
                    </div>
                    <div class="meter">
                        <div class="meter-bar">
                            <div class="meter-fill" id="meterFR" style="height: 0%"></div>
                        </div>
                        <div class="meter-label">Front Right</div>
                    </div>
                    <div class="meter">
                        <div class="meter-bar">
                            <div class="meter-fill" id="meterSL" style="height: 0%"></div>
                        </div>
                        <div class="meter-label">Side Left</div>
                    </div>
                    <div class="meter">
                        <div class="meter-bar">
                            <div class="meter-fill" id="meterSR" style="height: 0%"></div>
                        </div>
                        <div class="meter-label">Side Right</div>
                    </div>
                </div>

                <div class="controls">
                    <button id="btnSnapshot">üì∏ Snapshot</button>
                    <button id="btnRecord">üî¥ Start Recording</button>
                </div>
            </div>

            <div class="stats" id="stats">
                Connecting...
            </div>
        </div>
    </div>

    <script>
        const serverUrl = window.location.origin;
        let socket;
        let currentRobotId = null;
        let recording = false;

        // Stats
        let videoFrames = 0;
        let audioFrames = 0;
        let lastStatsTime = Date.now();

        function connect() {
            socket = io(serverUrl, {
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('statusText').textContent = 'Connected';

                // Join as viewer
                socket.emit('viewer:join', {}, (response) => {
                    console.log('Joined as viewer:', response);
                    if (response.robots && response.robots.length > 0) {
                        subscribeToRobot(response.robots[0].robotId);
                    }
                });
            });

            socket.on('disconnect', () => {
                document.getElementById('statusDot').classList.remove('connected');
                document.getElementById('statusText').textContent = 'Disconnected';
                showNoRobot();
            });

            socket.on('robot:connected', (data) => {
                console.log('Robot connected:', data);
                subscribeToRobot(data.robotId);
            });

            socket.on('robot:disconnected', (data) => {
                console.log('Robot disconnected:', data);
                if (data.robotId === currentRobotId) {
                    showNoRobot();
                }
            });

            socket.on('video:frame', (data) => {
                videoFrames++;
                const img = data.cameraId === 0 ?
                    document.getElementById('videoLeft') :
                    document.getElementById('videoRight');
                img.src = 'data:image/jpeg;base64,' + data.data;
            });

            socket.on('audio:frame', (data) => {
                audioFrames++;
                // Update audio meters (simplified visualization)
                updateAudioMeter(data.sourceId, data.data);
            });
        }

        function subscribeToRobot(robotId) {
            currentRobotId = robotId;
            socket.emit('viewer:join', { robotId });
            showRobotView();
            document.getElementById('statusText').textContent = `Connected to ${robotId}`;
        }

        function showNoRobot() {
            document.getElementById('noRobot').style.display = 'block';
            document.getElementById('robotView').style.display = 'none';
            currentRobotId = null;
        }

        function showRobotView() {
            document.getElementById('noRobot').style.display = 'none';
            document.getElementById('robotView').style.display = 'block';
        }

        function updateAudioMeter(sourceId, data) {
            // Simplified: just show random levels for demo
            // In real implementation, decode audio and calculate RMS
            const level = Math.random() * 60 + 10;

            if (sourceId === 0) {
                document.getElementById('meterFL').style.height = level + '%';
                document.getElementById('meterFR').style.height = (level * 0.9) + '%';
            } else {
                document.getElementById('meterSL').style.height = (level * 0.8) + '%';
                document.getElementById('meterSR').style.height = (level * 0.85) + '%';
            }
        }

        function updateStats() {
            const now = Date.now();
            const elapsed = (now - lastStatsTime) / 1000;

            const videoFps = (videoFrames / elapsed).toFixed(1);
            const audioFps = (audioFrames / elapsed).toFixed(1);

            document.getElementById('stats').textContent =
                `Video: ${videoFps} fps | Audio: ${audioFps} fps | Robot: ${currentRobotId || 'none'}`;

            videoFrames = 0;
            audioFrames = 0;
            lastStatsTime = now;
        }

        // Buttons
        document.getElementById('btnSnapshot').addEventListener('click', async () => {
            if (!currentRobotId) return;

            const response = await fetch(`${serverUrl}/robots/${currentRobotId}/snapshot`, {
                method: 'POST'
            });
            const result = await response.json();
            console.log('Snapshot saved:', result);
            alert('Snapshot saved!');
        });

        document.getElementById('btnRecord').addEventListener('click', async () => {
            if (!currentRobotId) return;

            const btn = document.getElementById('btnRecord');

            if (!recording) {
                await fetch(`${serverUrl}/robots/${currentRobotId}/recording/start`, {
                    method: 'POST'
                });
                btn.textContent = '‚èπÔ∏è Stop Recording';
                btn.style.background = '#f44336';
                recording = true;
            } else {
                const response = await fetch(`${serverUrl}/robots/${currentRobotId}/recording/stop`, {
                    method: 'POST'
                });
                const result = await response.json();
                console.log('Recording saved:', result);
                btn.textContent = 'üî¥ Start Recording';
                btn.style.background = '#e94560';
                recording = false;
                alert('Recording saved!');
            }
        });

        // Initialize
        connect();
        setInterval(updateStats, 1000);
    </script>
</body>
</html>
